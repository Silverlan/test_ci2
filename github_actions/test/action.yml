name: Run Pragma
description: 'Run Pragma'
inputs:
  lua-code:
    description: 'Lua Code'
    required: true
    default: ''
  state:
    description: 'Set to "client" for client-side execution, otherwise "server".'
    required: true
    default: 'client'
  version:
    description: 'The version of Pragma to download (if it not already exists).'
    required: true
    default: 'nightly'
outputs:
  exit-code:
    description: 'The result of the Lua code execution'
    value: ${{ steps.handle-result.outputs.exit-code }}
  error-code:
    description: 'The result of the Lua code execution'
    value: ${{ steps.handle-result.outputs.error-code }}
  lua-error:
    description: 'The result of the Lua code execution'
    value: ${{ steps.handle-result.outputs.lua-error }}
runs:
  using: "composite"
  steps:
    - name: Download Pragma
      shell: bash
      run: |
        if [ -d "pragma" ]; then
          echo "Pragma already exists. Skipping download."
        else
          repo="Silverlan/pragma"

          version="${{ inputs.version }}"

          dlUrl="https://github.com/Silverlan/pragma/releases/download/${version}/"
          if [ "$RUNNER_OS" == "Linux" ]; then
            if [ "$version" == "nightly" ]; then
              fileName="pragma-lin64.tar.gz"
            else
              fileName="pragma-${version}-lin64.tar.gz"
            fi
          else
            if [ "$version" == "nightly" ]; then
              fileName="pragma-win64.zip"
            else
              fileName="pragma-${version}-win64.zip"
            fi
          fi
          dlUrl="${dlUrl}${fileName}"

          curl -L "${dlUrl}" -o "${fileName}"
          mkdir pragma
          if [[ $fileName == *.tar.gz ]]; then
            tar -xzf ${fileName} -C pragma
          else
            unzip ${fileName} -d pragma
          fi
        fi

    - name: Copy Override Files (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        if (Test-Path -Path "pragma_override") {
          Copy-Item -Path "pragma_override\*" -Destination "pragma" -Recurse -Force
        } else {
          echo "Override directory does not exist. Skipping copy."
        }

    - name: Write Lua Code to File
      shell: bash
      run: |
        mkdir -p pragma/lua
        scriptFileName="pragma/lua/ci_script.lua"

        cat << 'EOF' > ${scriptFileName}
        local cb = game.add_callback("OnLuaError",function(err)
          print("A LUA ERROR HAS OCCURRED: ",err)
          file.write("ci.txt", "3")
          file.write("ci_lua_error.txt", err)
        end)
        EOF

        echo "file.write(\"ci.txt\", \"2\")" > ${scriptFileName}
        echo "${{ inputs.lua-code }}" >> ${scriptFileName}
        echo "file.write(\"ci.txt\", \"0\")" >> ${scriptFileName}
        cat ${scriptFileName}

    - name: Run Test Scripts
      shell: bash
      id: run-script
      run: |
        cd "pragma"
        if [ "$RUNNER_OS" == "Linux" ]; then
          chmod +x ./pragma
        fi
        executableName="pragma"
        luaCmdName="lua_exec"
        if [ "${{ inputs.state }}" == "client" ]; then
          luaCmdName="lua_exec_cl"
        fi
        if [ "$RUNNER_OS" == "Windows" ]; then
          if [ "${{ inputs.state }}" == "server" ]; then
            executableName="pragma_server"
          else
            executableName="pragma.com"
          fi
        elif [ "${{ inputs.state }}" == "server" ]; then
          executableName="pragma_server"
        fi
        ./${executableName} -cli -non_interactive -luaext -log 1 1 -log_file "log.txt" +map "empty" +"${luaCmdName} ci_script.lua" +"exit"

        EXIT_CODE=$?
        echo "exit-code=$(echo $EXIT_CODE)" >> $GITHUB_OUTPUT

    - name: Delete Lua Code File
      shell: bash
      run: |
        rm pragma/lua/ci_script.lua

    - name: Check Result
      id: handle-result
      shell: bash
      run: |
        echo "error-code=0" >> $GITHUB_OUTPUT
        
        exit_code=${{ steps.run-script.outputs.exit-code }}
        echo "exit-code=$exit_code" >> $GITHUB_OUTPUT

        if [ $exit_code -ne 0 ]; then
          error_code=1
          echo "error-code=$error_code" >> $GITHUB_OUTPUT
          exit $exit_code
        fi

        if [ -f "pragma/ci_lua_error.txt" ]; then
          CI_LUA_ERROR=$(cat "pragma/ci_lua_error.txt")
          exit_code=$?
          if [ $exit_code -ne 0 ]; then
            echo "lua-error=$(echo ${CI_LUA_ERROR})" >> $GITHUB_OUTPUT
          fi
        fi

        CI_CONTENTS=$(cat "pragma/ci.txt")
        exit_code=$?

        if [ $exit_code -ne 0 ]; then
          echo "error-code=3" >> $GITHUB_OUTPUT
          exit 1
        fi
        if [ "$CI_CONTENTS" -ne 0 ]; then
          echo "error-code=$CI_CONTENTS" >> $GITHUB_OUTPUT
          exit 2
        fi
